<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√în Thi GPLX ‚Äì Tr·∫Øc nghi·ªám 600 c√¢u</title>
  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      --bg-light:#f6f7fb; --card-light:#ffffff; --text-light:#0b1020; --muted-light:#4b5575; --accent-light:#3558ff; --ok-light:#17a34a; --bad-light:#e11d48; --warn-light:#f59e0b;
      --bg-dark:#0b1020; --card-dark:#11162a; --text-dark:#e7ebff; --muted-dark:#97a0c3; --accent-dark:#7aa2ff; --ok-dark:#46d37a; --bad-dark:#ff6b6b; --warn-dark:#ffd166;
    }
    body.light{ --bg:var(--bg-light); --card:var(--card-light); --text:var(--text-light); --muted:var(--muted-light); --accent:var(--accent-light); --ok:var(--ok-light); --bad:var(--bad-light); --warn:var(--warn-light); }
    body.dark { --bg:var(--bg-dark);  --card:var(--card-dark);  --text:var(--text-dark);  --muted:var(--muted-dark);  --accent:var(--accent-dark);  --ok:var(--ok-dark);  --bad:var(--bad-dark);  --warn:var(--warn-dark); }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); transition:background .25s,color .25s}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    .card{background:var(--card);border:1px solid #1d2542;border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #283160;background:#141b34;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:var(--accent);border-color:transparent;color:#0b1020}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn);color:#111}
    .btn.ok{background:var(--ok);color:#111}
    .btn.bad{background:var(--bad);color:#111}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#1a2348;border:1px solid #283160;color:var(--muted);font-size:12px}
    select, input[type="number"], input[type="text"]{background:#0f1630;border:1px solid #283160;color:#fff;padding:10px;border-radius:10px;width:100%}
    label{font-size:13px;color:var(--muted)}
    .qno{font-weight:700;color:var(--accent)}
    .option{border:1px solid #283160;border-radius:12px;padding:10px;display:flex;gap:10px;align-items:flex-start;background:#0f1630;cursor:pointer}
    .option input{margin-top:5px}
    .option.correct{border-color:#1fbf72;background:#0f1f1a}
    .option.wrong{border-color:#d9534f;background:#251419}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .footer{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .hidden{display:none}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#0a1128;border:1px solid #283160;border-bottom-width:3px;border-radius:8px;padding:2px 6px}
    .list{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(42px,1fr))}
    .num{border:1px solid #283160;border-radius:10px;line-height:40px;text-align:center;background:#0f1630;cursor:pointer}
    .num.mark{outline:2px dashed var(--warn)}
    .tag{font-size:11px;color:#9cb3ff;background:#0c1736;padding:2px 8px;border-radius:999px;border:1px solid #253166}
    .danger{color:#ff9aa0}
    .success{color:#85f7b7}
    .muted{color:var(--muted)}
    .divider{height:1px;background:#1d2542;margin:10px 0}
    details>summary{cursor:pointer}
    .imgwrap{background:#0c1736;border:1px solid #253166;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:180px;max-width:100%;overflow:hidden}
    .imgwrap img{max-width:100%;height:auto;display:block}
    .imgcap{margin-top:6px;font-size:12px;color:var(--muted)}
    .drop{border:2px dashed #2f3a6e;border-radius:12px;padding:16px;text-align:center;color:var(--muted)}

    /* Light theme tweaks */
    body.light .card{border-color:#e4e8ff; box-shadow:0 8px 24px rgba(17,24,39,.06)}
    body.light .btn{background:#eef1ff;border-color:#d5dbff;color:#0b1020}
    body.light .btn.ghost{background:transparent;border-color:#d5dbff;color:#0b1020}
    body.light .btn.primary{background:var(--accent);color:#fff}
    body.light select, body.light input[type="number"], body.light input[type="text"]{background:#ffffff;border-color:#d5dbff;color:#0b1020}
    body.light .option{background:#ffffff;border-color:#d5dbff}
    body.light .option.correct{background:#eefbf3;border-color:#b5f0cc}
    body.light .option.wrong{background:#fff1f3;border-color:#ffc9d2}
    body.light .pill{background:#eef1ff;border-color:#d5dbff;color:#4b5575}
    body.light .num{background:#ffffff;border-color:#d5dbff}
    body.light .imgwrap{background:#eef1ff;border-color:#d5dbff}
    body.light .drop{border-color:#c8d0ff;color:#4b5575}

    /* ===== Layout m·ªõi: Tr√°i = list, Ph·∫£i = c√¢u h·ªèi ===== */
    #examView{display:grid;gap:16px;grid-template-columns:320px 1fr}
    @media (max-width:1000px){#examView{grid-template-columns:1fr} .aside{position:static}}

    .aside{ position:sticky; top:16px; align-self:start }
    .sideTime{ font-size:44px; font-weight:800; text-align:center; padding:12px 0;
      border-radius:14px; background:#0f1630; border:1px solid #283160 }
    body.light .sideTime{ background:#fff }
    .kpis{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    .kpi{ background:#0f1630; border:1px solid #283160; border-radius:12px; padding:10px; text-align:center }
    .kpi b{ font-size:18px; display:block }
    .progress{height:10px;background:#0f1630;border:1px solid #283160;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0%}
    .progress>i.ok{ background:var(--ok) } .progress>i.warn{ background:var(--warn) }

    /* Sticky footer trong card c√¢u h·ªèi */
    .stickyBar{ position:sticky; bottom:0; background:var(--card); padding-top:8px; margin-top:12px; border-top:1px solid #1d2542 }

    /* Dock ƒëi·ªÅu h∆∞·ªõng d∆∞·ªõi m√†n h√¨nh */
    .dock{
      position:fixed; left:0; right:0; bottom:0; z-index:50; display:none;
      gap:8px; justify-content:center;
      background:rgba(11,16,32,.85); backdrop-filter: blur(6px);
      padding:10px 12px; border-top:1px solid #283160
    }
    body.light .dock{ background:rgba(255,255,255,.92) }
  </style>
</head>
<body class="dark">
  <div class="container">
    <header>
      <h1>√în ƒë·ªÅ GPLX</h1>
      <div class="row">
        <button class="btn ghost" id="btnReset">Xo√° ti·∫øn ƒë·ªô</button>
        <button class="btn warn" id="btnTheme">‚òÄÔ∏è</button>
      </div>
    </header>

    <!-- ===== HOME ===== -->
    <section class="card" id="homeView">
      <div class="row" style="justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <div class="pill">Theory ¬∑ Practice ¬∑ Exam</div>
          <h2 style="margin:10px 0 6px">Web √¥n t·∫≠p l√Ω thuy·∫øt GPLX</h2>
          <p class="muted">C√¢u h·ªèi ƒëa d·∫°ng ¬∑ Ng√¢n h√†ng ƒë·ªÅ l·ªõn ¬∑ C√≥ l·ªùi gi·∫£i chi ti·∫øt</p>
          <div class="divider"></div>
          <label>Nh·∫≠p t√™n c·ªßa b·∫°n</label>
          <input id="inpName" type="text" placeholder="V√≠ d·ª•: Qu·ªëc B·∫£o" />
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnGoStart">B·∫Øt ƒë·∫ßu √¥n t·∫≠p</button>
          </div>
        </div>
        <div class="imgwrap" style="flex:1;min-width:280px">
          <img alt="Hero" src="https://dummyimage.com/800x480/0c1736/9cb3ff&text=Theory+Practice+Exam"/>
        </div>
      </div>
    </section>

    <!-- ===== CONFIG VIEW ===== -->
    <section class="card" id="configView" style="display:none">
      <h3 style="margin-top:0">Ch·ªçn h·∫°ng & c·∫•u h√¨nh</h3>
      <div class="row">
        <div style="flex:1;min-width:160px">
          <label>H·∫°ng</label>
          <select id="selHang">
            <option value="ALL">T·∫•t c·∫£ (600 c√¢u)</option>
            <option value="A1">A1 (200 c√¢u)</option>
            <option value="A2">A2 (450 c√¢u)</option>
            <option value="B1B2">B1/B2 (600 c√¢u)</option>
          </select>
        </div>
        <div style="width:140px">
          <label>S·ªë c√¢u/ƒë·ªÅ</label>
          <input type="number" id="numCau" min="5" max="60" value="35" />
        </div>
        <div style="width:140px">
          <label>Th·ªùi gian (ph√∫t)</label>
          <input type="number" id="numTime" min="5" max="60" value="22" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnStart">B·∫Øt ƒë·∫ßu thi</button>
        <button class="btn" id="btnPractice">Luy·ªán ng·∫´u nhi√™n</button>
        <button class="btn warn" id="btnImport">Nh·∫≠p c√¢u h·ªèi (.json)</button>
      </div>
      <div class="divider"></div>
      <div class="drop" id="dropZone">K√©o th·∫£ file <b>questions.json</b> v√†o ƒë√¢y ho·∫∑c b·∫•m <span class="kbd">Nh·∫≠p c√¢u h·ªèi</span>.</div>
      <input class="hidden" type="file" id="fileInput" accept="application/json" />
    </section>

    <!-- ===== EXAM VIEW (Tr√°i list, Ph·∫£i c√¢u h·ªèi) ===== -->
    <section id="examView" style="display:none">
      <!-- LEFT: danh s√°ch c√¢u & info -->
      <aside class="card aside">
        <div class="sideTime" id="sideTime">--:--</div>
        <div style="margin:10px 0">
          <div class="row" style="justify-content:space-between">
            <span class="muted">Ti·∫øn ƒë·ªô</span>
            <span><b id="sideDone">0</b>/<b id="sideTotal">0</b></span>
          </div>
          <div class="progress" aria-label="progress">
            <i id="sideBar"></i>
          </div>
        </div>
        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><span class="muted">ƒê√°nh d·∫•u</span><b id="sideMarked">0</b></div>
          <div class="kpi"><span class="muted">C√¢u li·ªát</span><b id="sideLietTotal">0</b></div>
        </div>
        <div class="divider"></div>
        <h4 style="margin:6px 0">Danh s√°ch c√¢u</h4>
        <div class="list" id="listNums"></div>
      </aside>

      <!-- RIGHT: c√¢u h·ªèi -->
      <section class="card">
        <h3 style="margin-top:0">B√†i thi</h3>
        <div class="meta">
          <span class="pill">Th√≠ sinh: <b id="metaUser">-</b></span>
          <span class="pill">C√¢u: <b id="metaIdx">-</b>/<b id="metaTotal">-</b></span>
          <span class="pill">Th·ªùi gian: <b id="metaTime">--:--</b></span>
          <span class="pill" id="tagLiet" title="C√¢u ƒëi·ªÉm li·ªát" style="display:none">C√¢u li·ªát</span>
        </div>
        <div class="divider"></div>
        <div id="questionArea">
          <h3 class="qno">Ch∆∞a b·∫Øt ƒë·∫ßu</h3>
          <p class="muted">B·∫•m <b>B·∫Øt ƒë·∫ßu thi</b> ho·∫∑c <b>Luy·ªán ng·∫´u nhi√™n</b>.</p>
        </div>

        <!-- footer sticky trong card -->
        <div class="footer stickyBar">
          <div class="row">
            <button class="btn" id="btnPrev">‚óÄ Tr∆∞·ªõc</button>
            <button class="btn" id="btnNext">Ti·∫øp ‚ñ∂</button>
            <button class="btn ghost" id="btnMark">ƒê√°nh d·∫•u</button>
          </div>
          <div class="row">
            <button class="btn ok" id="btnSubmit">N·ªôp b√†i</button>
          </div>
        </div>
      </section>
    </section>

    <!-- ===== REVIEW VIEW ===== -->
    <section class="card" id="reviewCard" style="margin-top:16px;display:none"></section>
  </div>

  <!-- Dock ƒëi·ªÅu h∆∞·ªõng c·ªë ƒë·ªãnh -->
  <div class="dock" id="dockNav">
    <button class="btn" id="dPrev">‚óÄ Tr∆∞·ªõc</button>
    <button class="btn primary" id="dNext">Ti·∫øp ‚ñ∂</button>
    <button class="btn ok" id="dSubmit">N·ªôp b√†i</button>
  </div>

  <script>
    // ===== THEME TOGGLE =====
    let theme = localStorage.getItem('THEME') || 'dark';
    function applyTheme(){
      document.body.className = theme;
      const b = document.getElementById('btnTheme');
      if(b){ b.textContent = theme==='dark' ? '‚òÄÔ∏è S√°ng' : 'üåô T·ªëi'; }
    }
    function toggleTheme(){ theme = theme==='dark' ? 'light' : 'dark'; localStorage.setItem('THEME', theme); applyTheme(); }
    applyTheme();

    // ===== VIEWS & USER =====
    const V = { home: document.getElementById('homeView'), config: document.getElementById('configView'), exam: document.getElementById('examView') };
    const $ = (s)=>document.querySelector(s); const $$ = (s)=>document.querySelectorAll(s);
    const userKey='gplx_user_name';
    function show(view){ V.home.style.display = view==='home'?'' : 'none'; V.config.style.display = view==='config'?'' : 'none'; V.exam.style.display = view==='exam'?'' : 'none'; }
    $('#btnGoStart').onclick = ()=>{ const name = ($('#inpName').value||'').trim(); if(name) localStorage.setItem(userKey,name); show('config'); };

    // ===== AUTO LOAD questions.json =====
    let loadedQuestions = [];
    fetch('questions.json')
      .then(r => r.json())
      .then(data => {
        if (Array.isArray(data)) {
          loadedQuestions = data[0]?.questions ? data.flatMap(p => p.questions) : data;
          console.log('ƒê√£ load', loadedQuestions.length, 'c√¢u h·ªèi t·ª´ questions.json');
        }
      })
      .catch(err => console.warn('Kh√¥ng load ƒë∆∞·ª£c questions.json:', err));

    // ===== SAMPLE fallback =====
    const sampleQuestions = [
      { id:1, text:"Bi·ªÉn n√†o l√† bi·ªÉn c·∫•m v∆∞·ª£t?", answers:[
        {key:'A', text:'Bi·ªÉn tr√≤n vi·ªÅn ƒë·ªè, n·ªÅn tr·∫Øng, h√¨nh √¥ t√¥ m√†u ƒëen', correct:true},
        {key:'B', text:'Bi·ªÉn tam gi√°c n·ªÅn v√†ng', correct:false},
        {key:'C', text:'Bi·ªÉn vu√¥ng n·ªÅn xanh', correct:false},
        {key:'D', text:'Bi·ªÉn STOP b√°t gi√°c', correct:false},
      ], liet:false, image:"signs/cam_vuot_1.png", chapter:"Bi·ªÉn b√°o", hang:["ALL","B1B2"], explain:"Bi·ªÉn tr√≤n vi·ªÅn ƒë·ªè n·ªÅn tr·∫Øng c·∫•m ph∆∞∆°ng ti·ªán theo h√¨nh b√™n trong v∆∞·ª£t." },
      { id:2, text:"Khi xe ∆∞u ti√™n ƒëang ph√°t t√≠n hi·ªáu l√†m nhi·ªám v·ª•, ng∆∞·ªùi l√°i xe ph·∫£i l√†m g√¨?", answers:[
        {key:'A', text:'Nh∆∞·ªùng ƒë∆∞·ªùng ngay', correct:true},
        {key:'B', text:'ƒêi ti·∫øp v√¨ ƒë√®n xanh', correct:false},
        {key:'C', text:'TƒÉng t·ªëc v∆∞·ª£t', correct:false},
        {key:'D', text:'B·∫•m c√≤i xin ƒë∆∞·ªùng', correct:false},
      ], liet:true, image:"signs/sa_hinh_1.png", chapter:"Quy t·∫Øc", hang:["ALL","A1","A2","B1B2"], explain:"Xe ∆∞u ti√™n c√≥ quy·ªÅn ƒëi tr∆∞·ªõc; c√°c xe kh√°c ph·∫£i gi·∫£m t·ªëc, nh∆∞·ªùng ƒë∆∞·ªùng, d·ª´ng n·∫øu c·∫ßn." },
    ];

    // ===== STATE =====
    const state = {
      questions: [...sampleQuestions],
      current: 0,
      picked: {}, // id -> 'A'|'B'|...
      marked: new Set(),
      startedAt: null,
      deadline: null,
      timer: null,
      mode: 'idle', // idle|exam|practice|review
      config: {hang:'ALL', count:35, minutes:22},
    }

    // ===== STORAGE =====
    const KEY = 'gplx600_state_v1';
    function save(){ localStorage.setItem(KEY, JSON.stringify({
      picked: state.picked, marked:[...state.marked], config:state.config
    })); }
    function load(){ try{ const d = JSON.parse(localStorage.getItem(KEY)||'{}');
      if(d.picked) state.picked = d.picked; if(d.marked) state.marked = new Set(d.marked); if(d.config) state.config = d.config;
      $('#selHang').value = state.config.hang; $('#numCau').value = state.config.count; $('#numTime').value = state.config.minutes;
    }catch(e){}
    }

    // ===== UTILS =====
    const fmtTime = ms=>{ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}` };
    const shuffle = arr=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

    // ===== RENDER =====
    function renderList(){
      const wrap = $('#listNums');
      wrap.innerHTML='';
      state.questions.forEach((q,idx)=>{
        const d = document.createElement('div');
        d.className='num'+(state.marked.has(q.id)?' mark':'');
        d.textContent = idx+1;
        if(state.picked[q.id]) d.style.background = '#0f2a2a';
        d.onclick=()=>{ state.current=idx; renderQuestion(); };
        wrap.appendChild(d);
      });
      renderSidebar();
    }

    function renderQuestion(){
      $('#metaUser').textContent = localStorage.getItem(userKey)||'-';
      $('#metaIdx').textContent = state.current+1;
      $('#metaTotal').textContent = state.questions.length;
      const q = state.questions[state.current];
      $('#tagLiet').style.display = q.liet ? '' : 'none';

      const area = $('#questionArea');
      const picked = state.picked[q.id] || null;
      const img = q.image ? `<div class="imgwrap"><img src="${q.image}" alt="minh ho·∫°" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('beforeend','<div class=\'muted\'>Kh√¥ng c√≥ h√¨nh ho·∫∑c sai ƒë∆∞·ªùng d·∫´n: ${q.image}</div>');"/></div><div class="imgcap">·∫¢nh: ${q.image}</div>`:'';

      const answersHtml = q.answers.map(a=>{
        const cls = (state.mode==='review')
          ? (a.correct? ' option correct' : (picked===a.key? ' option wrong':''))
          : ' option';
        const checked = picked===a.key ? 'checked' : '';
        return `<label class="${cls}"><input type="radio" name="opt" value="${a.key}" ${checked} ${state.mode==='review'?'disabled':''}/> <b>${a.key}.</b> <div>${a.text}</div></label>`;
      }).join('');

      const explainHtml = (state.picked[q.id] || state.mode==='review') && q.explain
        ? `<div class="divider"></div><div class="pill">Gi·∫£i th√≠ch</div><p class="muted" style="margin-top:6px">${q.explain}</p>`
        : '';

      const html = `
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="tag">Ch∆∞∆°ng: ${q.chapter||'-'}</div>
          <div class="tag">ID: ${q.id}</div>
        </div>
        <h3 class="qno">C√¢u ${state.current+1}. ${q.text}</h3>
        ${img}
        <div style="display:grid;gap:10px;margin-top:10px">${answersHtml}</div>
        ${explainHtml}
      `;
      area.innerHTML = html;

      $$('#questionArea input[name="opt"]').forEach(i=>{
        i.onchange = ()=>{ state.picked[q.id] = i.value; save(); renderList(); renderSidebar(); };
      });
    }

    function renderSidebar(){
      const elTotal = document.getElementById('sideTotal');
      const elDone  = document.getElementById('sideDone');
      const elMarked= document.getElementById('sideMarked');
      const elLiet  = document.getElementById('sideLietTotal');
      const bar     = document.getElementById('sideBar');
      if(!elTotal || !elDone || !elMarked || !elLiet || !bar) return;

      const total = state.questions.length;
      const done  = Object.keys(state.picked).length;
      const marked= state.marked.size;
      const lietTotal = state.questions.filter(q=>q.liet).length;

      elTotal.textContent = total || 0;
      elDone.textContent  = done  || 0;
      elMarked.textContent= marked|| 0;
      elLiet.textContent  = lietTotal || 0;

      const p = total ? Math.round(done*100/total) : 0;
      bar.style.width = p + '%';
      bar.className = p >= 80 ? 'ok' : 'warn';
    }

    function renderTimer(){
      if(state.mode!=='exam') return;
      const remain = state.deadline - Date.now();
      const t = fmtTime(remain);
      const meta = document.getElementById('metaTime'); if (meta) meta.textContent = t;
      const sideTime = document.getElementById('sideTime'); if (sideTime) sideTime.textContent = t;
      if(remain<=0){ submit(); }
    }

    function showReview(result){
      const {score, total, wrong, lietSai} = result;
      const wrap = $('#reviewCard');
      wrap.style.display='block';
      wrap.innerHTML = `
        <h3 style="margin-top:0">K·∫øt qu·∫£</h3>
        <p>ƒêi·ªÉm: <b class="success">${score}/${total}</b> | Sai: <b class="danger">${wrong.length}</b> ${lietSai? '| <b class="danger">SAI C√ÇU LI·ªÜT ‚Üí TR∆Ø·ª¢T</b>':''}</p>
        <div class="row" style="margin:10px 0">
          <button class="btn" id="btnRedoWrong">L√†m l·∫°i c√¢u sai</button>
          <button class="btn ghost" id="btnCloseReview">ƒê√≥ng</button>
          <button class="btn" id="btnBackHome">V·ªÅ trang ch·ªß</button>
        </div>
        <div class="divider"></div>
        <details open>
          <summary>Danh s√°ch c√¢u sai</summary>
          <ol id="wrongList"></ol>
        </details>
      `;
      const list = $('#wrongList');
      list.innerHTML='';
      wrong.forEach(idx=>{
        const q = state.questions[idx];
        const pickedKey = state.picked[q.id] || '-';
        const pickedObj = q.answers.find(a=>a.key===pickedKey);
        const correctObj = q.answers.find(a=>a.correct);

        const li = document.createElement('li');
        li.innerHTML = `
          <div><b>${q.text}</b></div>
          <div class="muted" style="margin:4px 0">
            B·∫°n ch·ªçn: <b>${pickedKey}</b>${pickedObj? ` ‚Äì ${pickedObj.text}`:''}
            ${q.liet? ' ‚Ä¢ <span class="danger">(C√¢u li·ªát)</span>':''}
          </div>
          <div>ƒê√°p √°n ƒë√∫ng: <b>${correctObj?.key||'-'}</b>${correctObj? ` ‚Äì ${correctObj.text}`:''}</div>
          ${q.explain ? `<div class="muted" style="margin-top:4px">Gi·∫£i th√≠ch: ${q.explain}</div>` : ''}
        `;
        list.appendChild(li);
      });

      $('#btnRedoWrong').onclick = ()=>{
        if(wrong.length===0) return;
        state.questions = wrong.map(i=>state.questions[i]);
        state.current = 0; state.mode='practice';
        renderList(); renderQuestion();
        wrap.style.display='none';
      }
      $('#btnCloseReview').onclick = ()=>{ wrap.style.display='none'; };
      $('#btnBackHome').onclick = ()=>{ show('home'); toggleDock(false); };
    }

    function submit(){
      // ch·∫•m ƒëi·ªÉm
      let score=0, lietSai=false; const wrong=[];
      state.questions.forEach((q,idx)=>{
        const picked = state.picked[q.id];
        const correct = q.answers.find(a=>a.correct)?.key;
        if(picked===correct) score++; else wrong.push(idx);
        if(q.liet && picked!==correct) lietSai=true;
      });
      state.mode='review';
      clearInterval(state.timer); state.timer=null; $('#metaTime').textContent='--:--';
      renderQuestion(); showReview({score, total:state.questions.length, wrong, lietSai});
      toggleDock(false);
    }

    // ===== KH·ªûI T·∫†O & S·ª∞ KI·ªÜN =====
    load();
    const savedName = localStorage.getItem(userKey)||''; if(savedName){ $('#inpName').value=savedName; }
    document.getElementById('btnTheme').onclick = toggleTheme;

    // chuy·ªÉn view ban ƒë·∫ßu
    show('home');

    $('#btnStart').onclick = ()=>{
      const hang = $('#selHang').value; const count = +$('#numCau').value; const minutes= +$('#numTime').value;
      state.config = {hang, count, minutes}; save();
      const pool = (loadedQuestions.length? loadedQuestions: sampleQuestions)
        .filter(q=>q.hang?.includes('ALL') || q.hang?.includes(hang));
      state.questions = shuffle(pool).slice(0, Math.min(count, pool.length));
      state.current = 0; state.picked={}; state.marked.clear();
      state.mode='exam'; state.startedAt=Date.now(); state.deadline= Date.now()+minutes*60*1000;
      if(state.timer) clearInterval(state.timer); state.timer=setInterval(renderTimer, 500);
      renderList(); renderQuestion(); renderTimer();
      $('#reviewCard').style.display='none';
      show('exam'); toggleDock(true); renderSidebar();
    }

    $('#btnPractice').onclick = ()=>{
      const hang = $('#selHang').value; state.config.hang = hang; save();
      const pool = (loadedQuestions.length? loadedQuestions: sampleQuestions)
        .filter(q=>q.hang?.includes('ALL') || q.hang?.includes(hang));
      state.questions = shuffle(pool).slice(0, Math.min(25, pool.length));
      state.current=0; state.mode='practice'; state.picked={}; state.marked.clear();
      if(state.timer) { clearInterval(state.timer); state.timer=null; }
      $('#metaTime').textContent='--:--';
      renderList(); renderQuestion();
      $('#reviewCard').style.display='none';
      show('exam'); toggleDock(true); renderSidebar();
    }

    $('#btnNext').onclick = ()=>{ if(state.current<state.questions.length-1){state.current++; renderQuestion();} };
    $('#btnPrev').onclick = ()=>{ if(state.current>0){state.current--; renderQuestion();} };
    $('#btnMark').onclick = ()=>{ const id = state.questions[state.current].id; if(state.marked.has(id)) state.marked.delete(id); else state.marked.add(id); save(); renderList(); };
    $('#btnSubmit').onclick = submit;

    $('#btnReset').onclick = ()=>{ localStorage.removeItem(KEY); localStorage.removeItem(userKey); location.reload(); };

    // Dock ƒëi·ªÅu h∆∞·ªõng (g·∫Øn v√†o n√∫t c√≥ s·∫µn)
    function toggleDock(on){ document.getElementById('dockNav').style.display = on ? 'flex' : 'none'; }
    document.getElementById('dPrev').onclick   = ()=> document.getElementById('btnPrev').click();
    document.getElementById('dNext').onclick   = ()=> document.getElementById('btnNext').click();
    document.getElementById('dSubmit').onclick = ()=> document.getElementById('btnSubmit').click();

    // Nh·∫≠p file JSON
    function handleFiles(file){
      if(!file) return; const reader = new FileReader();
      reader.onload = ()=>{ try {
        const arr = JSON.parse(reader.result);
        loadedQuestions = Array.isArray(arr) ? (arr[0]?.questions ? arr.flatMap(p=>p.questions) : arr) : [];
        alert('ƒê√£ n·∫°p '+loadedQuestions.length+' c√¢u h·ªèi!');
      } catch(e){ alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c JSON: '+e.message); }
      };
      reader.readAsText(file);
    }
    $('#btnImport').onclick = ()=> $('#fileInput').click();
    $('#fileInput').onchange = (e)=> handleFiles(e.target.files[0]);
    const drop = document.getElementById('dropZone');
    drop.ondragover = (e)=>{ e.preventDefault(); drop.style.background='#0f1630'; };
    drop.ondragleave = ()=>{ drop.style.background=''; };
    drop.ondrop = (e)=>{ e.preventDefault(); drop.style.background=''; handleFiles(e.dataTransfer.files[0]); };
  </script>
</body>
</html>
